# Database Schema

This directory contains the canonical database schema for the Albergue del Carrascalejo management system.

## Single Source of Truth

**Important**: The SQL migrations in this folder are the **single source of truth** for all data shapes. All frontend types and Rust backend models are generated from these schema definitions.

## Files

- `001_init_schema.sql` - Initial database schema with all tables, indexes, and seed data
- `schema.ts` - Drizzle ORM schema that matches the SQL migrations exactly
- `drizzle.config.ts` - Configuration for Drizzle kit to generate types
- `README.md` - This documentation file

## Schema Overview

### Core Tables

1. **users** - Authentication and user management
2. **pilgrims** - Pilgrim personal data (GDPR compliant with encrypted fields)
3. **beds** - Physical bed and room inventory management
4. **bookings** - Reservation and booking management with 2-hour timeout
5. **payments** - Payment processing and tracking
6. **pricing** - Dynamic pricing configuration
7. **government_submissions** - SOAP API compliance for government reporting

### Key Features

- **GDPR/NIS2 Compliance**: Sensitive personal data fields are encrypted at rest
- **2-Hour Reservation Window**: Automatic cleanup of expired reservations
- **Dynamic Pricing**: Configurable pricing per room/bed type
- **Government Integration**: SOAP XML submission tracking for compliance
- **Comprehensive Indexing**: Optimized for booking queries and status lookups

## Usage

### Running Migrations

```bash
# Apply migrations to development database
sqlx migrate run --database-url $DATABASE_URL

# Generate Drizzle types
npx drizzle-kit generate

# Prepare SQLx offline data for Rust services
cargo sqlx prepare --lib
```

### Accessing Schema Types

```typescript
// Frontend usage
import type { Booking, InsertBooking } from '@/database/schema';

// Rust usage (generated by sqlx)
use sqlx::FromRow;
#[derive(FromRow)]
struct Booking { /* ... */ }
```

## Migration History

- `001_init_schema.sql` - Initial schema migration with complete table definitions
- Future migrations will be numbered sequentially (002_, 003_, etc.)

## Data Retention and Compliance

- Personal data in `pilgrims` table is encrypted using AES-256-GCM
- `data_retention_until` field enables automatic GDPR compliance cleanup
- All data access is logged for audit purposes
- Government submission data is retained as required by Spanish tourism law